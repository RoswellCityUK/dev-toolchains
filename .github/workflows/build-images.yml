name: Build & Publish Images (Native)

on:
  push:
    branches: ["main"]
  pull_request:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  # -------------------------------------------------------------------------
  # JOB 1: Base Platform (Native Builders)
  # -------------------------------------------------------------------------
  build-base:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            platform: linux/amd64
            suffix: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64

    runs-on: ${{ matrix.runner }}
    outputs:
      texlive_version: ${{ steps.get_ver.outputs.year }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect TeX Live Version
        id: get_ver
        run: |
          YEAR=$(grep -oP '/usr/local/texlive/\K\d{4}' images/base-tex/Dockerfile | head -1)
          echo "year=$YEAR" >> $GITHUB_OUTPUT

      - name: Filter Paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'images/base-tex/**'
              - '.github/workflows/build-images.yml'

      - name: Should run?
        id: should_run
        if: steps.filter.outputs.src == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: echo "run=true" >> $GITHUB_OUTPUT

      - name: Lowercase Repository Name
        if: steps.should_run.outputs.run == 'true'
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Set up Docker Buildx
        if: steps.should_run.outputs.run == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.should_run.outputs.run == 'true' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Base
        if: steps.should_run.outputs.run == 'true'
        uses: docker/build-push-action@v6
        with:
          context: images/base-tex
          platforms: ${{ matrix.platform }}
          tags: ghcr.io/${{ env.REPO_LOWER }}/base-tex:latest-${{ matrix.suffix }}
          push: ${{ github.event_name != 'pull_request' }}
          cache-from: type=gha,scope=base-${{ matrix.suffix }}
          cache-to: type=gha,mode=max,scope=base-${{ matrix.suffix }}

  # -------------------------------------------------------------------------
  # JOB 2: Merge Base Manifests
  # -------------------------------------------------------------------------
  merge-base:
    needs: build-base
    runs-on: ubuntu-latest
    if: needs.build-base.result == 'success'
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Manifest List
        run: |
          REPO_LOWER=${GITHUB_REPOSITORY,,}
          docker buildx imagetools create -t ghcr.io/$REPO_LOWER/base-tex:latest \
            ghcr.io/$REPO_LOWER/base-tex:latest-amd64 \
            ghcr.io/$REPO_LOWER/base-tex:latest-arm64

          docker buildx imagetools create -t ghcr.io/$REPO_LOWER/base-tex:texlive-${{ needs.build-base.outputs.texlive_version }} \
            ghcr.io/$REPO_LOWER/base-tex:latest-amd64 \
            ghcr.io/$REPO_LOWER/base-tex:latest-arm64

  # -------------------------------------------------------------------------
  # JOB 3: Toolchains (Native Builders)
  # -------------------------------------------------------------------------
  build-toolchains:
    needs: [build-base, merge-base]
    strategy:
      fail-fast: false
      matrix:
        # Cross-product: 2 Images x 2 Architectures
        image: [latex, quarto]
        arch:
          - { runner: ubuntu-24.04, platform: linux/amd64, suffix: amd64 }
          - { runner: ubuntu-24.04-arm, platform: linux/arm64, suffix: arm64 }
        include:
          - image: latex
            context: images/toolchain-latex
            depends_on_base_tex: true
          - image: quarto
            context: images/toolchain-quarto
            depends_on_base_tex: true

    runs-on: ${{ matrix.arch.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Filter Paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - '${{ matrix.context }}/**'
              - '${{ matrix.depends_on_base_tex == true && 'images/base-tex/**' || '' }}'
              - '.github/workflows/build-images.yml'

      - name: Should run?
        id: should_run
        if: steps.filter.outputs.src == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: echo "run=true" >> $GITHUB_OUTPUT

      - name: Lowercase Repository Name
        if: steps.should_run.outputs.run == 'true'
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Set up Docker Buildx
        if: steps.should_run.outputs.run == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: steps.should_run.outputs.run == 'true' && github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Toolchain
        if: steps.should_run.outputs.run == 'true'
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          platforms: ${{ matrix.arch.platform }}
          tags: ghcr.io/${{ env.REPO_LOWER }}/toolchain-${{ matrix.image }}:latest-${{ matrix.arch.suffix }}
          push: ${{ github.event_name != 'pull_request' }}
          cache-from: type=gha,scope=${{ matrix.image }}-${{ matrix.arch.suffix }}
          cache-to: type=gha,mode=max,scope=${{ matrix.image }}-${{ matrix.arch.suffix }}

  # -------------------------------------------------------------------------
  # JOB 4: Merge Toolchain Manifests
  # -------------------------------------------------------------------------
  merge-toolchains:
    needs: build-toolchains
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: [latex, quarto]
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Manifest List
        run: |
          REPO_LOWER=${GITHUB_REPOSITORY,,}
          docker buildx imagetools create -t ghcr.io/$REPO_LOWER/toolchain-${{ matrix.image }}:latest \
            ghcr.io/$REPO_LOWER/toolchain-${{ matrix.image }}:latest-amd64 \
            ghcr.io/$REPO_LOWER/toolchain-${{ matrix.image }}:latest-arm64